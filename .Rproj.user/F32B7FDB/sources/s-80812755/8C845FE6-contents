library (vegan)
library(indicspecies)
###Load species data (with species abundance) and log-tranform
d <- read.csv("C:/Users/GIS/Desktop/Patch_Grasshoppers_Abundance_Matrix_RDA_most_frequent_species_morethan1studysites.csv", header = TRUE, sep =",", row.names = 1)
spe <- log1p (d)
### OR load species data (with presence/absences)
#d <- read.csv("C:/Users/GIS/Desktop/Patch_Grasshoppers_Abundance_Matrix_RDA_most_frequent_species_morethan1studysites_presence-absences.csv", header = TRUE, sep =",", row.names = 1)

#Load environment data
env <- read.csv("C:/Users/GIS/Desktop/R-Wildschweinprojekt/Data/Patch_level/Environment_variables_Wildschweinprojekt.csv", header = TRUE, sep =",", row.names = 1)
# group_plot <- as.factor(env[,18])
# group_new <- as.factor(env[,19])
group_old <- as.factor(env[,20])

### NMDS
nmds_ <- metaMDS(spe, distance = "bray", k = 2)
plot_nmds <- ordiplot(nmds_, type = "none", choices = c(1,2)) 

## Display sites points
#colvec <- c("red2", "mediumblue")
#points(nmds_, display = "sites", col=colvec[group_new], pch=19)
#points(nmds_, display = "sites", col=colvec[group_old], pch=19)
#legend("topright", legend=levels(group_old), bty="n", col=colvec, pch=19)

# Display hulls 
colvec <- c("orange", "purple")
ordihull(nmds_,groups=group_old,draw="polygon",col= colvec, label=F)
legend("topright", legend=levels(group_old), bty="n", col=colvec, pch=19)

# Display species 
#text(nmds_, display = "species", col="blue", cex=0.6)
ordipointlabel(nmds_, display = "species", col="blue", pch= "+", cex = 0.8, scaling = 9, add = T)

#PERMANOVA: model response of species assemblages to env.variables 
adonis2(spe~ env$rooting.old + 
            env$rooting.fresh  + 
            #env$Wb_freq_ind + 
            env$cover.herbs + 
            env$cover.litter + 
            env$max.height.herbs)
#Test variables for correlation 
cor(env[,c(5:9, 21:22)]) # no highly correlated variables to remove

# Display environment variables 
ef <- envfit(nmds_, env[, c(5, 
                            #7, 
                            22)])
plot(ef, col="black")


### RDA (constrained redundancy analysis)

### standard RDA
# ordi_logtrans <- rda(spe ~ env$R_old, data = env)
# ordiplot_logtrans <- ordiplot(ordi_logtrans,type= "text", display = c('species', 'bp'))
# anova (ordi_logtrans, permutations = 999)

# partial-RDA with the most influencial co-varaibles obtained by PERMANOVA: cover of herb
rooting <- env$rooting.old 
scl <- 3
ordi_logtrans <- rda(spe ~ rooting + 
                         Condition(env$cover.herbs, 
                                   # env$cover.litter
                                   ), 
                     data = env)

ordiplot(ordi_logtrans, display=c("sites", "bp"))
ordipointlabel(ordi_logtrans, display = 'species', pch= "+", cex = 0.8, scaling = scl, add = T)
anova (ordi_logtrans, permutations = 999)
ordi_logtrans
### Export diagrams
png("C:/Users/GIS/Desktop/R-Wildschweinprojekt/exports/plots/Patch_level/Lizards_grasshoppers/Ordination/RDA_Grasshoppers1.png")
ordiplot(ordi_logtrans, display=c("sites", "bp"))
ordipointlabel(ordi_logtrans, display = 'species', pch= "+", cex = 0.8, scaling = scl, add = T)
dev.off()

png("C:/Users/GIS/Desktop/R-Wildschweinprojekt/exports/plots/Patch_level/Lizards_grasshoppers/Ordination/NMDS_Grasshoppers.png")
plot_nmds <- ordiplot(nmds_, type = "none", choices = c(1,2)) 
ordihull(nmds_,groups=group_old,draw="polygon",col= colvec, label=F)
legend("topright", legend=levels(group_old), bty="n", col=colvec, pch=19)
plot(ef, col="black")
dev.off()

# ### Simper analysis
# spe_simper_old <- simper(spe, group = group_old, permutations = 999)
# summary(spe_simper_old)

###Indicator species analysis
spe_inval_old <- multipatt(spe, group_old, func = "IndVal.g", control = how(nperm=999))
summary(spe_inval_old)
